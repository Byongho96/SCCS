<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.scss.api.studyroom.mapper.StudyroomMapper">

  <resultMap id="studyList" type="StudyroomDto">
    <id column="id" property="id"/>
    <result column="title" property="title"/>
    <result column="is_private" property="isPrivate"/>
    <result column="type" property="type"/>
    <collection property="algoIds" ofType="Integer">
      <result column="algo_id"/>
    </collection>
    <collection property="languageIds" ofType="Integer">
      <result column="language_id"/>
    </collection>
  </resultMap>

  <resultMap id="studyList2" type="StudyroomDto">
    <id column="id" property="id"/>
    <result column="title" property="title"/>
    <collection property="algoIds" ofType="Integer">
      <result column="algo_id"/>
    </collection>
  </resultMap>

  <insert id="createStudyroom" parameterType="StudyroomDto" useGeneratedKeys="true" keyProperty="id">
    insert into studyroom(
    title,
    password,
    is_private
    )
    values(
    #{title},
    #{password},
    #{isPrivate}
    )
  </insert>
  <insert id="insertLanguageId" parameterType="StudyroomLanguageDto">
    insert into studyroom_language(
    language_id,
    studyroom_id
    )
    values(
    #{languageId},
    #{studyroomId}
    )
  </insert>
  <insert id="insertAlgoId" parameterType="StudyroomAlgoDto">
    insert into studyroom_algo(
    algo_id,
    studyroom_id
    )
    values(
    #{algoId},
    #{studyroomId}
    )
  </insert>

  <select id="selectProblemCount" parameterType="int" resultType="int">
    select count(*) from problem where algo_id=#{algoId}
  </select>

  <insert id="insertProblemId" parameterType="StudyroomProblemDto">
    insert into studyroom_problem(
    problem_id,
    studyroom_id
    )
    values(
    #{problemId},
    #{studyroomId}
    )
  </insert>

  <select id="selectProblemId" parameterType="String" resultType="int">
    select id from problem where problem_folder=#{path}
  </select>


  <insert id="insertMemberId" parameterType="StudyroomMemberDto">
    insert into studyroom_member(
    member_id,
    studyroom_id
    )
    values(
    #{memberId},
    #{studyroomId}
    )
  </insert>


  <select id="selectAllStudyroom" resultMap="studyList">
    SELECT s.id as id, s.title as title, s.is_private as is_private, s.type as type, sa.algo_id as algo_id , sl.language_id as language_id FROM studyroom s LEFT JOIN studyroom_algo sa ON s.id=sa.studyroom_id JOIN studyroom_language sl ON s.id=sl.studyroom_id
    where is_active=1
    order by create_datetime desc;
  </select>

  <select id="selectStudyroom" parameterType="StudyroomDto" resultMap="studyList">
    SELECT s.id as id, s.title as title, s.is_private as is_private, s.type as type, sa.algo_id as algo_id , sl.language_id as language_id FROM studyroom s LEFT JOIN studyroom_algo sa ON s.id=sa.studyroom_id JOIN studyroom_language sl ON s.id=sl.studyroom_id
    where is_active=1
    <if test="id != 0">
      AND s.id= #{id}
    </if>
    <if test="title!=null and title!=''">
      AND s.title = #{title}
    </if>
    <if test="algoIds.size!=0">
      <foreach collection="algoIds" item="item" open="AND (sa.algo_id=" close=")" separator="OR sa.algo_id=">
        #{item}
      </foreach>
    </if>
    <if test="languageIds.size!=0">
      <foreach collection="languageIds" item="item" open="AND (sl.language_id=" close=")" separator="OR sl.language_id=">
        #{item}
      </foreach>
    </if>
    order by create_datetime desc;
  </select>


  <select id="checkStudyroomPassword" parameterType="StudyroomDto" resultType="int">
    select count(*) from studyroom where id = #{id} and password = #{password}
  </select>

  <insert id="insertMemberIds" parameterType="StudyroomDto">
    insert into studyroom_member(
    member_id,
    studyroom_id
    )
    values
    <foreach collection="memberIds" item="item" open=""  separator=" , " >
      (#{item},  #{id})
    </foreach>
  </insert>

  <select id="selectStudyroomById" parameterType="int" resultMap="studyList2">
    SELECT s.id as id, s.title as title, sa.algo_id as algo_id FROM studyroom s
    LEFT JOIN studyroom_algo sa ON s.id=sa.studyroom_id where s.id=#{id};
  </select>

  <select id="selectProblemByStudyroomId" parameterType="int" resultType="ProblemDto">
    SELECT p.name, p.problem_folder FROM problem p
    LEFT JOIN studyroom_problem sp ON p.id=sp.problem_id where sp.studyroom_id=#{id};
  </select>


  <insert id="submitProblem" parameterType="SubmissionDto">
    insert into submission(
    member_id,
    problem_id,
    language_id,
    studyroom_id,
    send_file_name,
    store_file_name
    )
    values (#{memberId}, #{problemId}, #{languageId}, #{studyroomId}, #{sendFileName}, #{storeFileName})
  </insert>

</mapper>